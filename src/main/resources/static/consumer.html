<html>
    <head>
        <title>Kadmin @ BetterCloud</title>
        <link href="css/bootstrap.min.css" rel="stylesheet">
        <style>
            pre {
                padding: 5px;
                margin: 5px;
            }
            .string { color: green; }
            .number { color: darkorange; }
            .boolean { color: blue; }
            .null { color: magenta; }
            .key { color: red; }
        </style>
    </head>
    <body>
        <div class="container">
            <div>
                <ul class="nav nav-pills">
                    <li role="presentation"><a href="/">Home</a></li>
                    <li role="presentation"class="active"><a href="/consumer.html" target="_blank">Consumer</a></li>
                </ul>
            </div>
            <div class="panel panel-default">
                <div class="panel-body">
                    <div class="row">
                        <div class="form-group col-sm-6">
                            <label for="kafkahost">Kafka Host</label>
                            <input type="text" class="form-control" id="kafkahost" placeholder="localhost:9092">
                        </div>
                        <div class="form-group col-sm-6">
                            <label for="schemaurl">Kafka Schema Registry Url</label>
                            <input type="text" class="form-control" id="schemaurl" placeholder="http://localhost:8081">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="topic">Topic</label>
                        <input type="text" class="form-control" id="topic">
                    </div>
                    <div class="row text-right">
                        <button class="btn btn-primary" id="start-consumer-btn">
                            Start Consumer
                        </button>
                    </div>
                </div>
            </div>
            <div class="message-container">
                <div class="title-row">
                    <h2>Messages</h2>
                </div>
                <div id="message-list"></div>
            </div>
        </div>

        <script type="text/javascript" src="js/jquery.min.js"></script>
        <script type="text/javascript" src="js/underscore-min.js"></script>
        <script type="text/javascript" src="js/bootstrap.min.js"></script>
        <script type="text/javascript" src="js/moment.min.js"></script>
        <script type="text/template" id="message-tile-template">
            <div class="panel panel-default">
                <div class="panel-body">
                    Key: <%= key %> @<%= writeTimeText %>
                    <pre><%= messageText %></pre>
                </div>
            </div>
        </script>
        <script>
            var count = 0,
                consumerConfig = {
                    started: false,
                    kafkaUrl: null,
                    schemaUrl: null,
                    topic: null,
                    since: null,
                    autoRefresh: null
                },
                messageTemplate = _.template($('#message-tile-template').html()),
                $messageList = $('#message-list');

            function initConfig() {
                let topic = $('#topic').val();
                if (!topic || topic === "") {
                    alert("Topic is required. Aborting creating consumer.");
                    return false;
                }
                consumerConfig = {
                    started: true,
                    kafkaUrl: $('#kafkahost').val(),
                    schemaUrl: $('#schemaurl').val(),
                    topic: $('#topic').val(),
                    since: -1,
                    autoRefresh: true
                };
                if (consumerConfig.kafkaUrl === "") {
                    consumerConfig.kafkaUrl = null;
                }
                if (consumerConfig.schemaUrl === "") {
                    consumerConfig.schemaUrl = null;
                }
                if (consumerConfig.autoRefresh) {
                    setInterval(refresh, 10000);
                }
                return true;
            }

            function refresh() {
                if (!consumerConfig.started) {
                    if (!initConfig()) {
                        return;
                    }
                }
                let url = buildUrl();
                consumerConfig.since = new Date().getTime();
                $.get(url, handleResults);
            }

            function buildUrl() {
                let url = "/kafka/read/" + consumerConfig.topic
                        + "?since=" + consumerConfig.since;
                if (!!consumerConfig.kafkaUrl) {
                    url += "&kafkaUrl=" + consumerConfig.kafkaUrl;
                }
                if (!!consumerConfig.schemaUrl) {
                    url += "&schemaUrl=" + consumerConfig.schemaUrl;
                }
                return url;
            }

            function handleResults(data) {
                console.log(data);
                _.each(data.content, function(ele) {
                    let html = "";
                    ele.writeTimeText = moment(ele.writeTime).format('LTS');
                    ele.messageText = "null";
                    if (!!ele.message) {
                        ele.messageText = syntaxHighlight(JSON.stringify(ele.message, null, 2));
                    }
                    html = messageTemplate(ele);
                    $messageList.prepend(html);
                    document.title = "(" + ++count + ") " + consumerConfig.topic;
                });
            }

            function syntaxHighlight(json) {
                json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                    var cls = 'number';
                    if (/^"/.test(match)) {
                        if (/:$/.test(match)) {
                            cls = 'key';
                        } else {
                            cls = 'string';
                        }
                    } else if (/true|false/.test(match)) {
                        cls = 'boolean';
                    } else if (/null/.test(match)) {
                        cls = 'null';
                    }
                    return '<span class="' + cls + '">' + match + '</span>';
                });
            }


            $(document).ready(function() {
                $('#start-consumer-btn').click(function(e) {
                    e.preventDefault();
                    // TODO: disable button and form
                    refresh();
                });
            });
        </script>
    </body>
</html>